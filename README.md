# Runway

Site generator for the [Side-by-Side Blueprint](https://github.com/e-vergo/Side-By-Side-Blueprint) toolchain.

Runway consumes artifacts generated by [Dress](https://github.com/e-vergo/Dress) and LaTeX source files to produce an interactive HTML site that displays formal Lean proofs alongside LaTeX mathematical statements.

**Attribution**: This project is a pure-Lean port of [leanblueprint](https://github.com/PatrickMassot/leanblueprint) by Patrick Massot. The original leanblueprint uses Python/Plastex for site generation. Runway reimplements this functionality entirely in Lean 4, enabling tighter integration with the Lean toolchain and build-time soundness guarantees.

## Role in the Toolchain

Runway is the final stage of the Side-by-Side Blueprint pipeline:

```
SubVerso -> LeanArchitect -> Dress -> Runway
              |                |
              |            (artifacts)
              +-> Verso
```

It reads:
- Dress artifacts from `.lake/build/dressed/` (declaration HTML, hover data, dependency graph, manifest.json)
- LaTeX source from `blueprint.tex` (chapter/section structure, prose)
- Configuration from `runway.json`

It generates:
- Multi-page HTML site with chapter navigation
- Dashboard homepage with stats, key theorems, messages, project notes
- Interactive dependency graph with pan/zoom and modals
- Paper/PDF output with verification badges (optional)

## Installation

Add Runway as a dependency in `lakefile.lean`:

```lean
require Runway from git
  "https://github.com/e-vergo/Runway.git" @ "main"
```

Then build:

```bash
lake build runway
```

The executable is available at `.lake/build/bin/runway`.

## CLI Commands

### build (default)

Generate HTML site from Dress artifacts:

```bash
lake exe runway build runway.json
lake exe runway build                    # Uses runway.json in current directory
lake exe runway --output _site build     # Custom output directory
```

Output is written to `.lake/build/runway/` by default.

### paper

Generate ar5iv-style paper HTML from `paper.tex`:

```bash
lake exe runway paper runway.json
```

Generates:
- `paper_tex.html` - MathJax-rendered paper with verification badges
- `paper.pdf` - Compiled PDF (if LaTeX compiler available)
- `pdf_tex.html` - PDF viewer page

Processes `\paperstatement{}`, `\paperfull{}`, and `\paperproof{}` hooks, linking to Lean declarations.

### pdf

Generate PDF from LaTeX source:

```bash
lake exe runway pdf runway.json
lake exe runway pdf --tex-only           # Generate .tex only, no compilation
```

Uses `paperTexPath` if set, otherwise `blueprintTexPath`.

### serve

Start a local HTTP server for preview:

```bash
lake exe runway serve
```

Serves files from the output directory on `http://localhost:8000`.

### check

Verify Lean declarations exist:

```bash
lake exe runway check runway.json
```

Reports declarations with `notReady` status.

## CLI Options

| Option | Description |
|--------|-------------|
| `--build-dir <path>` | Lake build directory (default: `.lake/build`) |
| `--output <path>` | Output directory (default: `.lake/build/runway`) |
| `--tex-only` | Generate .tex file only, skip PDF compilation |
| `-h`, `--help` | Show help message |
| `-v`, `--version` | Show version information |

## Configuration

Create a `runway.json` file in your project root:

```json
{
  "title": "My Blueprint",
  "projectName": "MyProject",
  "blueprintTexPath": "blueprint/src/blueprint.tex",
  "assetsDir": "../dress-blueprint-action/assets",
  "githubUrl": "https://github.com/user/MyProject",
  "docgen4Url": "docs/",
  "baseUrl": "/",
  "paperTexPath": "blueprint/src/paper.tex",
  "pdfCompiler": "tectonic"
}
```

### Configuration Fields

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| `title` | String | No | `"Blueprint"` | Site title shown in browser |
| `projectName` | String | Yes | - | Lean project name (must match lakefile) |
| `blueprintTexPath` | String | Yes | - | Path to blueprint.tex |
| `assetsDir` | String | Yes | - | Directory containing CSS/JS assets |
| `githubUrl` | String | No | - | Repository URL for links |
| `docgen4Url` | String | No | - | URL to DocGen4 documentation |
| `baseUrl` | String | No | `"/"` | Base URL for site links |
| `outputDir` | String | No | `"_site"` | Output directory for generated HTML |
| `runwayDir` | String | No | - | Alternative: directory containing `src/blueprint.tex` and `src/paper.tex` |
| `paperTexPath` | String | No | - | Path to paper.tex (enables paper generation) |
| `pdfCompiler` | String | No | auto-detect | LaTeX compiler: `tectonic`, `pdflatex`, `xelatex`, `lualatex` |

### Path Resolution

- Relative paths in the config are resolved relative to the config file's directory
- The `runwayDir` option provides an alternative to specifying individual tex paths: if set, Runway looks for `{runwayDir}/src/blueprint.tex` and `{runwayDir}/src/paper.tex`

## Output Structure

```
.lake/build/runway/
  index.html            # Dashboard homepage
  chapter-*.html        # Chapter pages (from blueprint.tex structure)
  dep_graph.html        # Dependency graph page
  paper_tex.html        # Paper (if paperTexPath configured)
  pdf_tex.html          # PDF viewer (if paperTexPath + compiler available)
  paper.pdf             # PDF (if paperTexPath + compiler available)
  blueprint_verso.html  # Verso Blueprint (if Blueprint.lean exists)
  paper_verso.html      # Verso Paper (if Paper.lean exists)
  pdf_verso.html        # Verso PDF viewer (if Paper.lean exists)
  manifest.json         # Copied from Dress
  assets/
    blueprint.css
    common.css
    dep_graph.css
    paper.css
    plastex.js
    verso-code.js
```

## Input: Dress Artifacts

Runway reads from `.lake/build/dressed/`:

```
.lake/build/dressed/
  {Module}/
    {label}/
      decl.tex          # LaTeX statement and proof
      decl.html         # Lean code with syntax highlighting
      decl.json         # Metadata
      decl.hovers.json  # Hover information
  dep-graph.json        # Dependency graph data
  dep-graph.svg         # Pre-rendered SVG
  manifest.json         # Stats, validation, metadata
```

## Manifest Integration

The `manifest.json` file (generated by Dress) contains precomputed data:

```json
{
  "stats": { "notReady": 5, "proven": 20, "fullyProven": 8, ... },
  "checkResults": { "isConnected": true, "cycles": [] },
  "keyDeclarations": ["thm-main", "thm-pnt"],
  "messages": [{"id": "lem-helper", "message": "Needs refactoring"}],
  "projectNotes": { "blocked": [...], "potentialIssues": [...] }
}
```

This data is used directly without recomputation, providing a soundness guarantee that the displayed stats match the compiled artifacts.

## Module Reference Support

Runway supports including all declarations from a Lean module using `\inputleanmodule{}` in LaTeX:

```latex
\chapter{Wiener's Theorem}

This chapter contains the formalization of Wiener's theorem.

\inputleanmodule{PrimeNumberTheoremAnd.Wiener}
```

This expands to all `@[blueprint]`-annotated declarations from the specified module, rendered in definition order.

Module names must be fully qualified (e.g., `MyProject.Chapter.Module`).

## Paper Generation

Runway generates academic papers that link back to Lean formalizations.

### LaTeX Hooks

Use these commands in `paper.tex`:

```latex
% Insert LaTeX statement with verification badge and link to blueprint
\paperstatement{thm:main}

% Insert full side-by-side display (statement + Lean code)
\paperfull{thm:main}

% Insert proof with verification status
\paperproof{thm:main}
```

### Paper Metadata

Metadata is automatically extracted from `paper.tex`:

| LaTeX Command | Extracted Field |
|---------------|-----------------|
| `\title{...}` | Paper title (fallback to `config.title`) |
| `\author{...}` | Authors (split on `\and`) |
| `\begin{abstract}...\end{abstract}` | Abstract text |

### Supported Compilers

Runway auto-detects available LaTeX compilers in this order:
1. **tectonic** (preferred - self-contained, fast)
2. **pdflatex** (most common)
3. **xelatex** (Unicode support)
4. **lualatex** (Lua scripting)

Override with `pdfCompiler` in config.

## Node Status Model

Runway renders 6 status colors, matching the Dress/LeanArchitect status model:

| Status | Color | Hex | Source |
|--------|-------|-----|--------|
| `notReady` | Sandy Brown | #F4A460 | Default or manual flag |
| `ready` | Light Sea Green | #20B2AA | Manual flag |
| `sorry` | Dark Red | #8B0000 | Auto-detected: proof contains sorryAx |
| `proven` | Light Green | #90EE90 | Auto-detected: complete proof |
| `fullyProven` | Forest Green | #228B22 | Auto-computed: proven + all ancestors proven |
| `mathlibReady` | Light Blue | #87CEEB | Manual flag |

Status indicators appear throughout the UI: dashboard, blueprint headers, TOC, modals, paper theorem headers.

### Backwards Compatibility

JSON parsing handles legacy status values from older manifest files:
- `"stated"` maps to `.notReady`
- `"inMathlib"` maps to `.mathlibReady`

## Module Structure

| Module | Purpose |
|--------|---------|
| `Main.lean` | CLI entry point and command handlers |
| `Runway/Config.lean` | Configuration types and JSON parsing |
| `Runway/Site.lean` | `NodeInfo`, `ChapterInfo`, `SectionInfo`, `BlueprintSite` types |
| `Runway/Render.lean` | `RenderM` monad, dashboard rendering, node rendering |
| `Runway/Theme.lean` | `Theme` structure, page templates, sidebar generation |
| `Runway/Templates.lean` | Reusable HTML template components |
| `Runway/DepGraph.lean` | Dependency graph page, modals, toolbar, legend |
| `Runway/Paper.lean` | Paper HTML generation, `PaperMetadata` extraction |
| `Runway/Pdf.lean` | PDF compilation with multiple compilers |
| `Runway/Graph.lean` | `NodeStatus`, `Graph`, `Node`, `Edge` types |
| `Runway/Genre.lean` | Verso Genre definition for Blueprint documents |
| `Runway/Doc.lean` | Blueprint-specific document extensions for Verso |
| `Runway/Traverse.lean` | `TraverseM` monad for loading artifacts |
| `Runway/Dress/Load.lean` | Dress artifact loading, `EnhancedManifest`, `CheckResults` |
| `Runway/Latex/` | LaTeX lexer, parser, AST, HTML/LaTeX conversion |
| `Runway/Macros.lean` | MathJax macro extraction from LaTeX preamble |
| `Runway/DocGen4.lean` | doc-gen4 URL generation for API documentation links |
| `Runway/VersoPaper.lean` | VersoPaper genre integration |
| `Runway/AvailableDocuments.lean` | Document availability tracking for sidebar |
| `Runway/Assets.lean` | Asset copying utilities |
| `Runway/Html/Render.lean` | HTML rendering utilities |

### Data Flow

1. **Dress artifacts**: Precomputed during `lake build` with `BLUEPRINT_DRESS=1`
2. **Manifest loading**: `loadEnhancedManifest` loads stats, validation, node metadata
3. **LaTeX parsing**: `parseFile` extracts chapter/section structure
4. **Node assignment**: `assignPagePaths` and `assignDisplayNumbers` locate nodes in chapters
5. **Site building**: `buildSiteFromArtifacts` constructs `BlueprintSite`
6. **HTML generation**: Theme templates render pages with sidebar navigation
7. **Asset copying**: CSS/JS copied from `assetsDir` to output

## Required Assets

The `assetsDir` must contain:
- `blueprint.css` - Main stylesheet
- `common.css` - Base styles (status dots, rainbow brackets, theme toggle)
- `dep_graph.css` - Dependency graph styles
- `plastex.js` - LaTeX proof toggle
- `verso-code.js` - Hover initialization, pan/zoom, modal handling

These are provided by [dress-blueprint-action](https://github.com/e-vergo/dress-blueprint-action).

## Dependencies

Runway depends on:

| Dependency | Purpose |
|------------|---------|
| [Dress](https://github.com/e-vergo/Dress) | Provides LeanArchitect, SubVerso, artifact rendering |
| [Verso](https://github.com/e-vergo/verso) | Document framework for genre definition |

The dependency chain:

```
SubVerso -> LeanArchitect -> Dress -> Runway
              |
              +-> Verso (SBSBlueprint, VersoPaper genres)
```

## Lake Facet

Runway provides a `runway` library facet that depends on Dress's `blueprint` facet:

```lean
library_facet runway (lib : LeanLib) : Unit := do
  let ws ← getWorkspace
  let dressJob ← fetch <| lib.facet `blueprint
  dressJob.mapM fun _ => do
    let buildDir := ws.root.buildDir
    let runwayDir := getRunwayDir buildDir
    IO.FS.createDirAll runwayDir
    -- Generate HTML
```

This ensures Dress artifacts are built before Runway generation.

## Example Projects

### SBS-Test

Minimal test project (25 nodes, all 6 status colors):
- Located at `../SBS-Test/` in the Side-by-Side Blueprint monorepo
- Fast iteration for testing changes

### General Crystallographic Restriction

Production example with paper generation:
- Repository: [e-vergo/General_Crystallographic_Restriction](https://github.com/e-vergo/General_Crystallographic_Restriction)
- Uses full pipeline: dashboard, dependency graph, paper, PDF

### PrimeNumberTheoremAnd

Large-scale integration (530 annotations, 33 files):
- Repository: [AlexKontorovich/PrimeNumberTheoremAnd](https://github.com/AlexKontorovich/PrimeNumberTheoremAnd)
- Terence Tao's Prime Number Theorem project

## Development

### Building

```bash
lake build
```

### Testing

Test with SBS-Test for fast iteration:

```bash
cd ../SBS-Test
./scripts/build_blueprint.sh
# Site served at localhost:8000
```

## Related Projects

| Project | Purpose |
|---------|---------|
| [SubVerso](https://github.com/e-vergo/subverso) | Syntax highlighting extraction (fork with O(1) lookups) |
| [LeanArchitect](https://github.com/e-vergo/LeanArchitect) | `@[blueprint]` attribute with 8 metadata + 3 status options |
| [Dress](https://github.com/e-vergo/Dress) | Artifact generation during `lake build` |
| [Verso](https://github.com/e-vergo/verso) | Document framework (fork with SBSBlueprint/VersoPaper genres) |
| [dress-blueprint-action](https://github.com/e-vergo/dress-blueprint-action) | GitHub Action + CSS/JS assets |

## License

Apache 2.0
