# Runway

> Static site generator for Side-by-Side Blueprint

Runway is the presentation layer of the Side-by-Side Blueprint toolchain. It consumes artifacts generated by [Dress](https://github.com/e-vergo/Dress) and LaTeX source files to produce an interactive HTML site that displays formal Lean proofs alongside LaTeX mathematical statements.

## Overview

Runway sits at the end of the Side-by-Side Blueprint pipeline:

```
SubVerso -> LeanArchitect -> Dress -> Runway
                              |
                          (artifacts)
```

It reads:
- Dress artifacts from `.lake/build/dressed/` (declaration HTML, hover data, dependency graph)
- LaTeX source from `blueprint.tex` (chapter/section structure, prose)
- Configuration from `runway.json`

It generates:
- Multi-page HTML site with chapter navigation
- Interactive dependency graph with D3.js pan/zoom
- Dashboard with stats, key theorems, validation checks
- Paper/PDF output (optional)

## Features

- **Side-by-side Lean/LaTeX display**: Synchronized proof toggles for both columns
- **Interactive dependency graph**: D3.js with pan/zoom, node modals with full content
- **Dashboard homepage**: Stats, key theorems, user messages, project notes
- **Paper/PDF generation**: `\paperstatement{}`, `\paperfull{}` hooks for academic papers
- **Multi-chapter structure**: Parses LaTeX `\chapter` and `\section` commands
- **DocGen4 integration**: Links to API documentation
- **Validation display**: Connectivity checks, cycle detection results

## Installation

Runway is a Lean 4 project. Build from source:

```bash
cd Runway
lake build
```

The executable is generated at `.lake/build/bin/runway`.

## Configuration

Create a `runway.json` file in your project root:

```json
{
  "title": "My Blueprint",
  "projectName": "MyProject",
  "blueprintTexPath": "blueprint/src/blueprint.tex",
  "assetsDir": "../dress-blueprint-action/assets",
  "githubUrl": "https://github.com/user/MyProject",
  "docgen4Url": "docs/",
  "baseUrl": "/",
  "paperTexPath": "blueprint/src/paper.tex",
  "paperTitle": "Paper Title",
  "paperAuthors": ["Author One", "Author Two"],
  "paperAbstract": "Abstract text...",
  "pdfCompiler": "tectonic"
}
```

### Configuration Options

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| `title` | String | No | `"Blueprint"` | Site title shown in browser |
| `projectName` | String | **Yes** | - | Lean project name |
| `blueprintTexPath` | String | **Yes** | - | Path to blueprint.tex |
| `assetsDir` | String | **Yes** | - | Directory containing CSS/JS assets |
| `githubUrl` | String | No | - | Repository URL for links |
| `docgen4Url` | String | No | - | URL to DocGen4 documentation |
| `baseUrl` | String | No | `"/"` | Base URL for site links |
| `paperTexPath` | String | No | - | Path to paper.tex (enables paper generation) |
| `paperTitle` | String | No | - | Paper title (falls back to `title`) |
| `paperAuthors` | Array | No | `[]` | Paper author names |
| `paperAbstract` | String | No | - | Paper abstract text |
| `pdfCompiler` | String | No | auto-detect | LaTeX compiler: `tectonic`, `pdflatex`, `xelatex`, `lualatex` |

## CLI Commands

### build (default)

Generate HTML site from Dress artifacts:

```bash
lake exe runway build runway.json
lake exe runway build                    # Uses runway.json in current directory
lake exe runway --output _site build     # Custom output directory
```

Output is written to `.lake/build/runway/` by default.

### serve

Start a local HTTP server for preview:

```bash
lake exe runway serve
```

Serves files from the output directory on `http://localhost:8000`.

### paper

Generate ar5iv-style paper HTML from `paper.tex`:

```bash
lake exe runway paper runway.json
```

Processes `\paperstatement{}`, `\paperfull{}`, and `\paperproof{}` hooks, linking to Lean declarations.

### pdf

Generate PDF from LaTeX source:

```bash
lake exe runway pdf runway.json
lake exe runway pdf --tex-only           # Generate .tex only, no compilation
```

Uses `paperTexPath` if set, otherwise `blueprintTexPath`.

### check

Verify Lean declarations exist:

```bash
lake exe runway check runway.json
```

Reports declarations with `notReady` status.

## CLI Options

| Option | Description |
|--------|-------------|
| `--build-dir <path>` | Lake build directory (default: `.lake/build`) |
| `--output <path>` | Output directory (default: `.lake/build/runway`) |
| `--tex-only` | Generate .tex file only, skip PDF compilation |
| `-h`, `--help` | Show help message |
| `-v`, `--version` | Show version information |

## Paper Generation

Runway supports generating academic papers that link back to Lean formalizations.

### LaTeX Hooks

Use these commands in your `paper.tex`:

```latex
% Insert LaTeX statement with verification badge and link
\paperstatement{thm:main}

% Insert full side-by-side display (statement + Lean code)
\paperfull{thm:main}

% Insert proof with verification status
\paperproof{thm:main}
```

### Supported Compilers

Runway auto-detects available LaTeX compilers in this order:
1. **tectonic** (preferred - self-contained, fast)
2. **pdflatex** (most common)
3. **xelatex** (Unicode support)
4. **lualatex** (Lua scripting)

Override with `pdfCompiler` in config or install your preferred compiler.

### Output Files

- `paper.html` - MathJax-rendered paper with verification badges
- `paper.pdf` - Compiled PDF
- `pdf.html` - PDF viewer page with embedded PDF

## Integration

### Input: Dress Artifacts

Runway reads from `.lake/build/dressed/`:

```
.lake/build/dressed/
  Module/
    label/
      decl.tex        # LaTeX statement and proof
      decl.html       # Lean code with highlighting
      decl.json       # Metadata
      decl.hovers.json # Hover information
  dep-graph.json      # Dependency graph
  dep-graph.svg       # Pre-rendered SVG
  manifest.json       # Stats, validation, metadata
```

### Input: LaTeX Source

Runway parses `blueprint.tex` to extract:
- Chapter and section structure
- `\inputleanmodule{}` references
- `\inputleannode{}` references
- Custom LaTeX macros (passed to MathJax)

### Output: HTML Site

```
.lake/build/runway/
  index.html          # Dashboard homepage
  chapter-*.html      # Chapter pages
  dep_graph.html      # Dependency graph page
  paper.html          # Paper (if configured)
  pdf.html            # PDF viewer (if configured)
  paper.pdf           # PDF (if configured)
  manifest.json       # Copied from Dress
  assets/
    blueprint.css
    common.css
    plastex.js
    verso-code.js
    paper.css
```

### Required Assets

The `assetsDir` must contain:
- `blueprint.css` - Main stylesheet
- `common.css` - Base styles
- `plastex.js` - LaTeX proof toggle
- `verso-code.js` - Hover initialization, pan/zoom, modal handling

These are provided by [dress-blueprint-action](https://github.com/e-vergo/dress-blueprint-action).

## Example Projects

### General Crystallographic Restriction

Production example with paper generation:

- Repository: [e-vergo/General_Crystallographic_Restriction](https://github.com/e-vergo/General_Crystallographic_Restriction)
- Uses full pipeline: dashboard, dependency graph, paper, PDF

### PrimeNumberTheoremAnd

Large-scale integration (530 annotations, 33 files):

- Repository: [AlexKontorovich/PrimeNumberTheoremAnd](https://github.com/AlexKontorovich/PrimeNumberTheoremAnd)
- Terence Tao's Prime Number Theorem project

### SBS-Test

Minimal test project for development:

- Located at `../SBS-Test/` in the Side-by-Side Blueprint monorepo
- Fast iteration for testing changes

## Related Projects

| Project | Purpose |
|---------|---------|
| [Dress](https://github.com/e-vergo/Dress) | Artifact generation during `lake build` |
| [LeanArchitect](https://github.com/e-vergo/LeanArchitect) | `@[blueprint]` attribute with metadata options |
| [SubVerso](https://github.com/e-vergo/subverso) | Syntax highlighting extraction (fork) |
| [dress-blueprint-action](https://github.com/e-vergo/dress-blueprint-action) | GitHub Action + CSS/JS assets |

## Development

### Building

```bash
lake build
```

### Testing

Test with SBS-Test for fast iteration:

```bash
cd ../SBS-Test
./scripts/build_blueprint.sh
# Site served at localhost:8000
```

### Module Structure

| Module | Purpose |
|--------|---------|
| `Main.lean` | CLI entry point and command handlers |
| `Config.lean` | Configuration types and JSON parsing |
| `Site.lean` | NodeInfo, ChapterInfo, BlueprintSite types |
| `Render.lean` | Side-by-side rendering, dashboard |
| `DepGraph.lean` | Dependency graph page generation |
| `Theme.lean` | Page templates, sidebar navigation |
| `Paper.lean` | Paper HTML generation |
| `Pdf.lean` | PDF compilation |
| `Latex/Parser.lean` | LaTeX parsing |
| `Latex/ToHtml.lean` | LaTeX to HTML conversion |
| `Latex/ToLatex.lean` | LaTeX hook resolution |
| `Macros.lean` | MathJax macro extraction |

## License

Apache 2.0
